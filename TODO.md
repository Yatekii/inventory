# Project TODO List

Centralized tracking of pending improvements and technical debt.

## High Priority

### SSH Keys: Migrate to Clan Vars System

**File:** `modules/clan/ssh-keys.nix`

Currently using a hardcoded SSH public key. Should migrate to clan's vars system for better secret management.

**To fix:**

1. Update `modules/clan/ssh-keys.nix` to use `clan.core.vars.generators`
2. Run `clan vars generate fenix` and `clan vars generate aiur`
3. Enter the SSH public key when prompted
4. Remove the hardcoded key

**Example vars-based implementation:**

```nix
{ config, ... }:
{
  clan.core.vars.generators.main-ssh-key = {
    prompts.main-ssh-key-pub = {
      description = "Main SSH public key for authorized access";
      type = "line";
      persist = true;
    };
    files.main-ssh-key-pub = {
      secret = false;
    };
  };

  users.users.root.openssh.authorizedKeys.keys = [
    config.clan.core.vars.generators.main-ssh-key.files.main-ssh-key-pub.value
  ];
}
```

### DNS A Record for auth.huesser.dev

**Urgency:** Required before deploying Kanidm

Set up DNS A record for `auth.huesser.dev` pointing to fenix's IP (see machines/machines.json).

## Medium Priority

### Hetzner Port 25

Request port 25 unblock from Hetzner support for fenix to enable outbound email delivery.

### Stalwart Web UI Limitations

The Stalwart Web UI has two known issues:

1. **In-memory directory not reflected in Web UI:** When using a memory-type directory for declarative user management, the API/Web UI doesn't expose full principal data (emails, descriptions). The dashboard shows 0 users/domains even though authentication and mail delivery work correctly. To fix this, either:
   - Switch to internal directory with API sync (loses declarative config)
   - Wait for Stalwart to add better in-memory directory API support
   - Consider Stalwart Enterprise

2. **Live Telemetry is Enterprise-only:** The "Not found" errors on dashboard pages (Overview, Delivery, etc.) are because Live Tracing/Telemetry endpoints are only available in Stalwart Enterprise Edition.

### DNS Records for Email

Set up DNS records for `huesser.dev` and `jarty.ch`:

- MX records pointing to mail.huesser.dev / mail.jarty.ch
- SPF records
- DMARC records
- DKIM records (generated by Stalwart after first run)

## Low Priority

### Conduwuit Matrix Server

Complete the Matrix/Conduwuit setup on aiur (currently partially configured/commented out).

### Migrate More Services to Kanidm SSO

Once Kanidm is stable, migrate other services:

- Mealie (currently using Zitadel on aiur)
- Future services

## Completed

### Kanidm SSO Setup

- [x] Created `modules/clan/kanidm.nix` with declarative user/group management
- [x] Configured OAuth2 for Stalwart mail server
- [x] Added Caddy reverse proxy for auth.huesser.dev
- [x] Created noah@huesser.dev user account with mail.access group
- [x] Updated README with Kanidm documentation
- [x] Auto-generate initial user passwords via systemd oneshot service
